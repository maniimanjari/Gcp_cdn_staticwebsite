# Host a Static Website on GCP With Load Balancer and CDN using Terraform

**CDN**
Cloud CDN uses Googleâ€™s global edge network to serve content closer to users, which accelerates your websites and applications. Cloud CDN content can be sourced from various types of backends: Instance groups, Zonal network endpoint groups (NEGs), Internet network endpoint groups (NEGs), and Google Cloud Storage Bucket. In this article, we will focus on Google Cloud Storage for static web site. 

Pre-requisites:
1. We need Backend Bucket to store the terraform state files.
2. Appropriate Permissions to the user and Reserve IP address.

**terraform_state**
Resource google_storage_bucket creates a gcs bucket to store terraform state files.

`Execution:  `
    `cd terraform_state
    terraform init
    terraform plan`

**IAM_POLICY**
The variable _**member**_ and the _**project_id**_ should be defined in the terraform.tfvars 
variable  _**member**_  the array of members for whom the storage admin and loadbalancer admin rights will be provided.

This script also reserves **IP address** which we would need to input in the terraform.tfvars located in base directory. 

`Execution:`
 `cd IAM_policy
 terraform init 
 terraform plan`

Now we will create Private storage bucket, an external HTTPS Load balancer with google managed ssl certificate, a global forwarding rule to the desired IP address and upload files to the GCP Storage Bucket using **google_storage_bucket_object** resource.
google_compute_url_map resource creates url re-direction to the desired path.

variable.tf file contains the definition and its description of variables. _terraform.tfvars_ should contain the values of variables defined in the variable.tf file.  

Variable _**packageDIR**_ if defined in the terraform.tfvars or during run time then the shell packages will be copied from it to bucket.

After uploading the files , resource "google_storage_object_acl" with role_entity sets those to be public. 

**Steps to run the script:**

Please make sure  you have installed Terraform already, if not please follow the blog https://www.terraform.io/docs/cli/install/apt.html

Commands:
    terraform init <to initialise and load required plugins.>
    terraform plan <to display the execution plan.>
    terraform apply <execute the pre-determined set of actions generated by a terraform plan.>
 
Terraform uses the local state(terraform.tfstate) to create plans and make changes to your infrastructure. Prior to any operation, Terraform does a refresh to update the state.
Thus, when on any version change in the variable.tf file, terraform compares the files that were already pushed and files to be pushed now, and analyses how many to add and destroy accordingly.
This feature helps us not to consume space in the gcp bucket with the shell files.


**Use Infrastructure as Terraform module as follows in a seperate Git repository if suitable**
module "gcp_cdn_staticwebsite"{
source = "git@github.com:maniimanjari/Gcp_cdn_staticwebsite.git"
name = var.name
domain = var.domain
project_id = var.project_id
location = var.location
IP_address = var.IP_address
region = var.region
Environment = var.Environment
packageDIR = var.packageDIR
}
